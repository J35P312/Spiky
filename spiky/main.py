#!/usr/bin/env python3
import argparse
import sys

import coverage_bed
import predict_sex
import generate_regions
import model
import predict

TOOL_VERSION = "0.0.0"

def main():
    parser = argparse.ArgumentParser(
        description="Spiky: fetal fraction calculator",add_help=False
    )

    # Listing the modules
    parser.add_argument("--coverage-bed", action="store_true", help="Generate windowed coverage BED from BAM")
    parser.add_argument("--predict-sex", action="store_true", help="Predict sample sex from coverage BED")
    parser.add_argument("--generate-regions", action="store_true", help="Generate robust chrY regions from multiple predict-sex outputs")
    parser.add_argument("--model", action="store_true", help="Train linear regression model for FFY from coverage BEDs")
    parser.add_argument("--predict", action="store_true", help="Predict FFY for a coverage BED using a trained model")
    parser.add_argument("--version", action="store_true", help="Print the version of the tool")
    args, unknown = parser.parse_known_args()

    if args.coverage_bed:
        # ---------------- coverage-bed arguments ----------------
        parser = argparse.ArgumentParser(
          description="Spiky: fetal fraction calculator"
        )
        parser.add_argument("--coverage-bed", action="store_true", help="Generate windowed coverage BED from BAM")
        parser.add_argument("--bam", help="Path to input BAM file")
        parser.add_argument("--bin-size", type=int, default=1000, help="Window/bin size in base pairs")
        parser.add_argument("--mapping-quality", type=int, default=20, help="Minimum mapping quality to include a read")
        parser.add_argument("--reference-fasta", help="Indexed reference FASTA for chromosome lengths")
        args = parser.parse_args()

        if not args.bam:
            parser.error("--coverage-bed requires --bam")
        coverage_bed.run(
            bam_path=args.bam,
            ref_path=args.reference_fasta,
            bin_size=args.bin_size,
            mapq_threshold=args.mapping_quality,
            out=sys.stdout
        )

    elif args.predict_sex:
        # ---------------- predict-sex arguments ----------------
        parser = argparse.ArgumentParser(
            description="Spiky: fetal fraction calculator"
        )
        parser.add_argument("--predict-sex", action="store_true", help="Predict sample sex from coverage BED")
        parser.add_argument("--coverage-bed-file", help="Coverage BED file generated by coverage-bed")
        parser.add_argument("--reference-fasta", help="Indexed reference FASTA for chromosome lengths")
        parser.add_argument("--y-frac-threshold", type=float, default=0.02, help="Minimum fraction coverage on chrY to call male")
        parser.add_argument("--lowq-threshold", type=float, default=0.1, help="Maximum fraction of low-quality reads per bin")
        parser.add_argument("--max-n-frac", type=float, default=0.2, help="Maximum allowed fraction of Ns per bin in reference")
        args = parser.parse_args()

        if not args.coverage_bed_file or not args.reference_fasta:
            parser.error("--predict-sex requires --coverage-bed-file and --reference-fasta")
        predict_sex.run(
            coverage_bed_path=args.coverage_bed_file,
            reference_fasta=args.reference_fasta,
            y_frac_threshold=args.y_frac_threshold,
            lowq_threshold=args.lowq_threshold,
            max_n_frac=args.max_n_frac,
            out=sys.stdout
        )

    elif args.generate_regions:
        # ---------------- generate-regions arguments ----------------
        parser = argparse.ArgumentParser(
            description="Spiky: fetal fraction calculator"
        )
        parser.add_argument("--generate-regions", action="store_true", help="Generate robust chrY regions from multiple predict-sex outputs")
        parser.add_argument("--sample-list", help="Text file listing paths to predict-sex output files")
        parser.add_argument("--female-median-y-threshold", type=float, default=0.01, help="Maximum median chrY fraction for females to consider a bin usable")
        parser.add_argument("--female-median-x-threshold", type=float, default=0.01, help="Maximum median chrX fraction deviation from 1 for females to consider a bin usable")
        parser.add_argument("--csv-out", help="Path to output CSV file summarizing bins per sample")
        args = parser.parse_args()

        if not args.sample_list or not args.csv_out:
            parser.error("--generate-regions requires --sample-list and --csv-out")
        generate_regions.run(
            sample_list_path=args.sample_list,
            female_median_y_threshold=args.female_median_y_threshold,
            female_median_x_threshold=args.female_median_x_threshold,
            out_bed=sys.stdout,
            out_csv_path=args.csv_out
        )

    elif args.model:
        # ---------------- model arguments ----------------
        parser = argparse.ArgumentParser(
            description="Spiky: fetal fraction calculator"
        )
        parser.add_argument("--model", action="store_true", help="Train linear regression model for FFY from coverage BEDs")
        parser.add_argument("--training-csv", help="CSV file with columns: BED file path, fetal fraction")
        parser.add_argument("--regions-bed", help="Regions BED produced by generate-regions")
        parser.add_argument("--model-out", help="Output JSON file containing the linear regression model")
        args = parser.parse_args()

        if not args.training_csv or not args.regions_bed or not args.model_out:
            parser.error("--model requires --training-csv, --regions-bed, and --model-out")
        # REMOVE 'out' here — model.run does not accept it
        model.run(
            training_csv=args.training_csv,
            regions_bed=args.regions_bed,
            model_out=args.model_out
        )

    elif args.predict:
        # ---------------- predict arguments ----------------
        parser = argparse.ArgumentParser(
            description="Spiky: fetal fraction calculator"
        )
        parser.add_argument("--predict", action="store_true", help="Predict FFY for a coverage BED using a trained model")
        parser.add_argument("--model-file", help="Trained model JSON file from model module")
        parser.add_argument("--regions-bed", help="Regions BED produced by generate-regions")
        parser.add_argument("--coverage-bed-file", help="Coverage BED file generated by coverage-bed")
        args = parser.parse_args()

        if not args.coverage_bed_file or not args.regions_bed or not args.model_file:
            parser.error("--predict requires --coverage-bed-file, --regions-bed, and --model-file")
        # REMOVE 'out' here — predict.run does not accept it
        predict.run(
            coverage_bed=args.coverage_bed_file,
            regions_bed=args.regions_bed,
            model_file=args.model_file
        )

    elif args.version:
        print(TOOL_VERSION)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()
